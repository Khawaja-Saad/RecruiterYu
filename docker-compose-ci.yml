version: "3.8"

services:
  backend_ci:
    image: python:3.10-slim
    container_name: recruiter_backend_ci
    working_dir: /app
    volumes:
      - ./backend:/app
    environment:
      - MONGO_URI=mongodb://mongo_ci:27017/recruiteryu_db
    command: >
      bash -lc "
        pip install --no-cache-dir -r requirements.txt || true &&
        (uvicorn main:app --host 0.0.0.0 --port 8000 ||
         uvicorn app:app --host 0.0.0.0 --port 8000 ||
         uvicorn backend.main:app --host 0.0.0.0 --port 8000)"
    ports:
      - "8081:8000"
    depends_on:
      - mongo_ci

  mongo_ci:
    image: mongo:6
    container_name: recruiter_mongo_ci
    restart: unless-stopped
    volumes:
      - mongo_data_ci:/data/db
    ports:
      - "27018:27017"
    environment:
      - MONGO_INITDB_DATABASE=recruiteryu_db

  frontend_ci:
    image: nginx:alpine
    container_name: recruiter_frontend_ci
    ports:
      - "3001:80"
    volumes:
      - ./frontend/build:/usr/share/nginx/html
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend_ci

volumes:
  mongo_data_ci:

